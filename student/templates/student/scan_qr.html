{% extends 'base_student.html' %}

{% block title %}Scan QR Code{% endblock %}

{% block content_wrapper %}
<div class="main-content mt-4">
    {% block content %}
    <div class="card">
        <h1 class="gradient-text">Scan QR Code</h1>
        <div id="qr-reader" style="width: 100%"></div>
        <div id="qr-reader-results"></div>
    </div>

    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const classId = {{ class_obj.id }};
            const chatSocket = new WebSocket(
                'ws://'
                + window.location.host
                + '/ws/notification/'
                + classId
                + '/'
            );

            chatSocket.onmessage = function(e) {
                const data = JSON.parse(e.data);
                alert(data.message);
            };

            chatSocket.onclose = function(e) {
                console.error('Chat socket closed unexpectedly');
            };

            function onScanSuccess(decodedText, decodedResult) {
                console.log(`Code matched = ${decodedText}`, decodedResult);
                // Send the QR code data to the server
                fetch("{% url 'student:mark_attendance' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        'qr_code_data': decodedText,
                        'class_id': classId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('qr-reader-results').innerHTML = `<div class="success">${data.message}</div>`;
                    } else {
                        document.getElementById('qr-reader-results').innerHTML = `<div class="error">${data.message}</div>`;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('qr-reader-results').innerHTML = `<div class="error">An error occurred.</div>`;
                });
            }

            var html5QrcodeScanner = new Html5QrcodeScanner(
                "qr-reader", { fps: 10, qrbox: 250 });
            html5QrcodeScanner.render(onScanSuccess);
        });
    </script>
    {% endblock %}
</div>
{% endblock %}