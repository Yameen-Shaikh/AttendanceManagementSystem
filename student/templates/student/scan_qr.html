{% extends 'base_student.html' %}

{% block title %}Scan QR Code{% endblock %}

{% block content_wrapper %}
<div class="main-content mt-4">
    {% block content %}
    <div class="card">
        <h1 class="gradient-text">Scan QR Code</h1>

        <div id="qr-reader" style="width: 100%"></div>
        <div id="qr-reader-results"></div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="scanResultModal" tabindex="-1" aria-labelledby="scanResultModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="scanResultModalLabel">Scan Result</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" id="scanResultModalBody">
            ...
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            function onScanSuccess(decodedText, decodedResult) {
                console.log(`Code matched = ${decodedText}`, decodedResult);
                
                // Send the QR code data to the server
                fetch("{% url 'student:mark_attendance' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        'qr_code_data': decodedText
                    })
                })
                .then(response => response.json())
                .then(data => {
                    const modalBody = document.getElementById('scanResultModalBody');
                    const modalTitle = document.getElementById('scanResultModalLabel');
                    if (data.success) {
                        modalTitle.innerText = 'Success';
                        modalBody.innerHTML = `<p>${data.message}</p>`;
                    } else {
                        modalTitle.innerText = 'Error';
                        modalBody.innerHTML = `<p>${data.message}</p>`;
                    }
                    var myModal = new bootstrap.Modal(document.getElementById('scanResultModal'), {});
                    myModal.show();
                })
                .catch(error => {
                    console.error('Error:', error);
                    const modalBody = document.getElementById('scanResultModalBody');
                    const modalTitle = document.getElementById('scanResultModalLabel');
                    modalTitle.innerText = 'Error';
                    modalBody.innerHTML = `<p>An error occurred.</p>`;
                    var myModal = new bootstrap.Modal(document.getElementById('scanResultModal'), {});
                    myModal.show();
                });
            }

            var html5QrcodeScanner = new Html5QrcodeScanner(
                "qr-reader", { fps: 10, qrbox: 250 });
            html5QrcodeScanner.render(onScanSuccess);
        });
    </script>
    {% endblock %}
</div>
{% endblock %}