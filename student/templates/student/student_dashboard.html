{% extends 'base_student.html' %}

{% block title %}My Dashboard{% endblock %}

{% block content_wrapper %}
<div class="main-content student-dashboard-content mt-4">
    {% block content %}
        <div class="card mb-3">
            <div class="card-body">
                <h1 class="mb-4">My Subjects</h1>
                
                <div class="form-group">
                    <label for="attendance-date" class="visually-hidden">Select date</label>
                    <input type="text" id="attendance-date" class="form-control" placeholder="Select date" onfocus="(this.type='date')" onblur="(this.type='text')">
                </div>
                <div id="attendance-result" class="mt-3"></div>

                {% for enrollment in enrollments %}
                    <h2 class="h5">{{ enrollment.class_obj.subject }}</h2>
                    <p class="mb-2">Overall Attendance: <strong>{{ enrollment.attendance_percentage }}%</strong></p>
                    <div class="progress-bar">
                        <div class="progress" data-progress="{{ enrollment.attendance_percentage|default:0 }}"></div>
                    </div>
                    <a href="{% url 'student:scan_qr_code' enrollment.class_obj.id %}" class="btn-grad mt-3">Mark Today's Attendance</a>
                {% empty %}
                    <p>You are not enrolled in any subjects yet.</p>
                {% endfor %}
            </div>
        </div>
    {% endblock content %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const progressBars = document.querySelectorAll('.progress');
        progressBars.forEach(bar => {
            const percentage = bar.dataset.progress;
            bar.style.width = percentage + '%';
        });

        document.getElementById('attendance-date').addEventListener('change', function() {
            const date = this.value;
            if (date) {
                document.getElementById('attendance-result').innerHTML = `<p>Checking attendance for ${date}...</p>`;
                
                fetch(`{% url 'student:get_attendance_by_date' %}?date=${date}`)
                    .then(response => response.json())
                    .then(data => {
                        let resultHtml = '';
                        if (data.length > 0) {
                            data.forEach(item => {
                                resultHtml += `<p><strong>${item.subject}:</strong> ${item.status}</p>`;
                            });
                        } else {
                            resultHtml = '<p>No attendance record for this date.</p>';
                        }
                        document.getElementById('attendance-result').innerHTML = resultHtml;
                    });
            } else {
                document.getElementById('attendance-result').innerHTML = '';
            }
        });
    });
</script>
</div>
{% endblock %}