{% extends 'base_teacher.html' %}

{% block title %}Generate QR Code{% endblock %}

{% block content_wrapper %}
<div class="main-content mt-4">
    {% block content %}
<div class="card">
    <div class="card-body">
        <!-- QR Code Section -->
        <div id="qrcode-container">
            <h4 class="text-center">{{ lecture.subject.class_obj.course.name }}</h4>
            <p class="text-center text-muted">Class: {{ lecture.subject.class_obj.name }}</p>
            <p class="text-center text-muted">Subject: {{ lecture.subject.name }}</p>
            <p class="text-center text-muted">Lecture: {{ lecture.date }} at {{ lecture.time }}</p>
            <div id="qrcode-display" class="d-flex justify-content-center mt-3"></div>
            <div id="timer" class="mt-3 text-center"></div>
        </div>
        <div id="expired-message" style="display: none;" class="text-center">
            <h2>QR Code has expired</h2>
        </div>

        <hr>

        <!-- Manual Attendance Section -->
        <div class="mt-3">
            <h5 class="card-title text-center">Manual Attendance</h5>
            <div id="manual-attendance-alert" class="alert" style="display:none;"></div>
            <form id="search-student-form" class="mt-3">
                <div class="input-group mb-3">
                    <input type="text" id="student-search-query" class="form-control" placeholder="Enter Student Name or Roll No." required>
                    <button class="btn btn-primary" type="submit">Search</button>
                </div>
            </form>
            <div id="student-search-results">
                <!-- Search results will be populated here -->
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
    new QRCode(document.getElementById("qrcode-display"), {
        text: "{{ qr_code_data }}",
        width: 256,
        height: 256,
        colorDark : "#000000",
        colorLight : "#ffffff",
        correctLevel : QRCode.CorrectLevel.H
    });

    var expiresAt = new Date("{{ expires_at }}");
    var timerElement = document.getElementById('timer');
    var qrcodeContainer = document.getElementById('qrcode-container');
    var expiredMessage = document.getElementById('expired-message');

    function countdown() {
        var now = new Date();
        var timeLeft = Math.round((expiresAt - now) / 1000);

        if (timeLeft <= 0) {
            clearInterval(timerId);
            qrcodeContainer.style.display = 'none';
            expiredMessage.style.display = 'block';
        } else {
            var minutes = Math.floor(timeLeft / 60);
            var seconds = timeLeft % 60;
            timerElement.innerHTML = "Expires in: " + minutes + "m " + seconds + "s";
        }
    }

    var timerId = setInterval(countdown, 1000);
    countdown(); // initial call

    // Manual Attendance Script
    document.getElementById('search-student-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const query = document.getElementById('student-search-query').value;
        const lectureId = "{{ lecture.id }}";
        const searchUrl = `/teacher/lecture/${lectureId}/search-students/?query=${encodeURIComponent(query)}`;

        fetch(searchUrl)
            .then(response => response.json())
            .then(data => {
                const resultsContainer = document.getElementById('student-search-results');
                resultsContainer.innerHTML = ''; // Clear previous results
                if (data.students && data.students.length > 0) {
                    const studentList = document.createElement('ul');
                    studentList.className = 'list-group';
                    data.students.forEach(student => {
                        const listItem = document.createElement('li');
                        listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                        listItem.innerHTML = `
                            <span>${student.name} (${student.roll_no || 'N/A'})</span>
                            <button class="btn btn-sm ${student.is_present ? 'btn-success' : 'btn-outline-primary'} mark-present-btn" 
                                    data-student-id="${student.id}" ${student.is_present ? 'disabled' : ''}>
                                ${student.is_present ? 'Present' : 'Mark Present'}
                            </button>
                        `;
                        studentList.appendChild(listItem);
                    });
                    resultsContainer.appendChild(studentList);
                } else {
                    resultsContainer.innerHTML = '<p class="text-center text-muted">No students found.</p>';
                }
            })
            .catch(error => {
                console.error('Error searching for students:', error);
                document.getElementById('student-search-results').innerHTML = '<p class="text-center text-danger">An error occurred during search.</p>';
            });
    });

    document.getElementById('student-search-results').addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('mark-present-btn')) {
            const button = e.target;
            const studentId = button.dataset.studentId;
            const lectureId = "{{ lecture.id }}";
            const markUrl = `/teacher/lecture/${lectureId}/mark-manual-attendance/`;

            const formData = new FormData();
            formData.append('student_id', studentId);
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

            fetch(markUrl, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                const alertDiv = document.getElementById('manual-attendance-alert');
                alertDiv.textContent = data.message;
                if (data.success) {
                    alertDiv.className = 'alert alert-success';
                    button.textContent = 'Present';
                    button.classList.remove('btn-outline-primary');
                    button.classList.add('btn-success');
                    button.disabled = true;
                } else {
                    alertDiv.className = 'alert alert-danger';
                }
                alertDiv.style.display = 'block';
                setTimeout(() => { alertDiv.style.display = 'none'; }, 3000);
            })
            .catch(error => {
                console.error('Error marking attendance:', error);
                const alertDiv = document.getElementById('manual-attendance-alert');
                alertDiv.textContent = 'An unexpected error occurred.';
                alertDiv.className = 'alert alert-danger';
                alertDiv.style.display = 'block';
                setTimeout(() => { alertDiv.style.display = 'none'; }, 3000);
            });
        }
    });
</script>
{% endblock %}
</div>
{% endblock %}
