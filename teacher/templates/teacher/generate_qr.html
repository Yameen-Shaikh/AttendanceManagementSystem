{% extends 'base_teacher.html' %}

{% block title %}Live Lecture Panel{% endblock %}

{% block content_wrapper %}
<div class="main-content mt-4">
    {% block content %}
    <div class="card">
        <div class="card-header">
            <h4 class="card-title text-center mb-0">Live Lecture Panel</h4>
            <p class="text-center text-muted mb-0">{{ lecture.subject.name }} | {{ lecture.date }} at {{ lecture.time }}</p>
        </div>
        <div class="card-body">
            <div class="row">
                <!-- Left side: QR Code and Manual Attendance -->
                <div class="col-lg-6">
                    <!-- QR Code Section -->
                    <div id="qrcode-container" class="text-center">
                        <div id="qrcode-display" class="justify-content-center mt-3"></div>
                        <div id="timer" class="mt-3"></div>
                    </div>
                    <div id="expired-message" style="display: none;" class="text-center">
                        <h5>QR Code has expired</h5>
                    </div>

                    <hr>

                    <!-- Manual Attendance Section -->
                    <div class="mt-3">
                        <h5 class="card-title text-center">Manual Attendance</h5>
                        <div id="manual-attendance-alert" class="alert" style="display:none;"></div>
                        <form id="search-student-form" class="mt-3">
                            <div class="input-group mb-3">
                                <input type="text" id="student-search-query" class="form-control" placeholder="Enter Student Name or Roll No." required>
                                <button class="btn btn-primary" type="submit">Search</button>
                            </div>
                        </form>
                        <div id="student-search-results"></div>
                    </div>
                </div>

                <!-- Right side: Pending Approvals -->
                <div class="col-lg-6 border-start">
                    <h5 class="card-title text-center">Pending Approvals</h5>
                    <div id="pending-approvals-alert" class="alert" style="display:none;"></div>
                    <div id="pending-approvals-list" class="list-group">
                        {% if not pending_students %}
                            <p class="text-center text-muted" id="no-pending-text">No pending approvals at the moment.</p>
                        {% else %}
                            {% for attendance in pending_students %}
                                <div class="list-group-item d-flex justify-content-between align-items-center" data-attendance-id="{{ attendance.id }}">
                                    <span>
                                        <strong>{{ attendance.student.name }}</strong>
                                    </span>
                                    <div>
                                        <button class="btn btn-sm btn-success approve-btn" data-attendance-id="{{ attendance.id }}">Approve</button>
                                        <button class="btn btn-sm btn-danger reject-btn" data-attendance-id="{{ attendance.id }}" data-bs-toggle="modal" data-bs-target="#rejectionModal">Reject</button>
                                    </div>
                                </div>
                            {% endfor %}
                        {% endif %}
                    </div>
                    <div class="mt-3 text-center">
                        <button class="btn btn-success" id="approve-all-btn">Approve All</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

<!-- Rejection Reason Modal -->
<div class="modal fade" id="rejectionModal" tabindex="-1" aria-labelledby="rejectionModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="rejectionModalLabel">Rejection Reason</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="rejection-form">
            <input type="hidden" id="reject-attendance-id">
            <div class="mb-3">
                <label for="rejection-reason" class="col-form-label">Please provide a reason for rejection:</label>
                <textarea class="form-control" id="rejection-reason" required></textarea>
            </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-danger" id="submit-rejection">Submit Rejection</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
    // QR Code Generation
    new QRCode(document.getElementById("qrcode-display"), {
        text: "{{ qr_code_data }}",
        width: 256,
        height: 256,
        colorDark : "#000000",
        colorLight : "#ffffff",
        correctLevel : QRCode.CorrectLevel.H
    });

    // QR Code Expiry Timer
    var expiresAt = new Date("{{ expires_at }}");
    var timerElement = document.getElementById('timer');
    var qrcodeContainer = document.getElementById('qrcode-container');
    var expiredMessage = document.getElementById('expired-message');

    function countdown() {
        var now = new Date();
        var timeLeft = Math.round((expiresAt - now) / 1000);

        if (timeLeft <= 0) {
            clearInterval(qrTimerId);
            qrcodeContainer.style.display = 'none';
            expiredMessage.style.display = 'block';
        } else {
            var minutes = Math.floor(timeLeft / 60);
            var seconds = timeLeft % 60;
            timerElement.innerHTML = "Expires in: " + minutes + "m " + seconds + "s";
        }
    }
    var qrTimerId = setInterval(countdown, 1000);
    countdown();

    const lectureId = parseInt("{{ lecture.id }}");
    const csrfToken = "{{ csrf_token }}";

    // Function to fetch and update pending attendances
    function updatePendingAttendances() {
        fetch(`/teacher/lecture/${lectureId}/pending-attendance/`)
            .then(response => response.json())
            .then(data => {
                const listContainer = document.getElementById('pending-approvals-list');
                const noPendingText = document.getElementById('no-pending-text');

                // Clear existing items except the no-pending text
                const existingItems = listContainer.querySelectorAll('.list-group-item');
                existingItems.forEach(item => item.remove());

                if (data.pending_students && data.pending_students.length > 0) {
                    if (noPendingText) {
                        noPendingText.style.display = 'none';
                    }
                    data.pending_students.forEach(attendance => {
                        const listItem = document.createElement('div');
                        listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                        listItem.dataset.attendanceId = attendance.attendance_id;
                        listItem.innerHTML = `
                            <span>
                                <strong>${attendance.name}</strong>
                            </span>
                            <div>
                                <button class="btn btn-sm btn-success approve-btn" data-attendance-id="${attendance.attendance_id}">Approve</button>
                                <button class="btn btn-sm btn-danger reject-btn" data-attendance-id="${attendance.attendance_id}" data-bs-toggle="modal" data-bs-target="#rejectionModal">Reject</button>
                            </div>
                        `;
                        listContainer.appendChild(listItem);
                    });
                } else {
                    if (noPendingText) {
                        noPendingText.style.display = 'block';
                    }
                }
            })
            .catch(error => console.error('Error fetching pending attendances:', error));
    }

    // Update pending attendances every 5 seconds
    setInterval(updatePendingAttendances, 5000);

    // Initial load
    updatePendingAttendances();

    // Handle Approval and Rejection
    document.getElementById('pending-approvals-list').addEventListener('click', function(e) {
        const target = e.target;
        const attendanceId = target.dataset.attendanceId;

        if (target.classList.contains('approve-btn')) {
            const approveUrl = `/teacher/attendance/${attendanceId}/approve/`;
            fetch(approveUrl, {
                method: 'POST',
                headers: { 'X-CSRFToken': csrfToken }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const item = document.querySelector(`[data-attendance-id="${attendanceId}"]`);
                    item.querySelector('.approve-btn').remove();
                    item.querySelector('.reject-btn').remove();
                    const status = document.createElement('span');
                    status.className = 'text-success';
                    status.textContent = 'Approved';
                    item.querySelector('div').appendChild(status);
                    showAlert('pending-approvals-alert', data.message, 'success');
                } else {
                    showAlert('pending-approvals-alert', data.message, 'danger');
                }
            })
            .catch(error => console.error('Error approving attendance:', error));
        } else if (target.classList.contains('reject-btn')) {
            document.getElementById('reject-attendance-id').value = attendanceId;
        }
    });

    document.getElementById('approve-all-btn').addEventListener('click', function() {
        const approveAllUrl = `/teacher/lecture/${lectureId}/approve-all/`;
        fetch(approveAllUrl, {
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const pendingList = document.getElementById('pending-approvals-list');
                const items = pendingList.querySelectorAll('.list-group-item');
                items.forEach(item => {
                    const approveBtn = item.querySelector('.approve-btn');
                    if (approveBtn) approveBtn.remove();
                    const rejectBtn = item.querySelector('.reject-btn');
                    if (rejectBtn) rejectBtn.remove();
                    const status = document.createElement('span');
                    status.className = 'text-success';
                    status.textContent = 'Approved';
                    item.querySelector('div').appendChild(status);
                });
                showAlert('pending-approvals-alert', data.message, 'success');
            } else {
                showAlert('pending-approvals-alert', data.message, 'danger');
            }
        })
        .catch(error => console.error('Error approving all attendance:', error));
    });
    
    document.getElementById('submit-rejection').addEventListener('click', function() {
        const attendanceId = document.getElementById('reject-attendance-id').value;
        const reason = document.getElementById('rejection-reason').value;
        const rejectUrl = `/teacher/attendance/${attendanceId}/reject/`;

        fetch(rejectUrl, {
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken, 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: 'rejected', reason: reason })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const item = document.querySelector(`[data-attendance-id="${attendanceId}"]`);
                item.querySelector('.reject-btn').remove();
                const status = document.createElement('span');
                status.className = 'text-danger';
                status.textContent = 'Rejected';
                item.querySelector('div').appendChild(status);
                showAlert('pending-approvals-alert', data.message, 'success');
                var modal = bootstrap.Modal.getInstance(document.getElementById('rejectionModal'));
                modal.hide();
                document.getElementById('rejection-form').reset();
            } else {
                showAlert('pending-approvals-alert', data.message, 'danger');
            }
        })
        .catch(error => console.error('Error rejecting attendance:', error));
    });


    // Manual Attendance Script
    document.getElementById('search-student-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const query = document.getElementById('student-search-query').value;
        const searchUrl = `/teacher/lecture/${lectureId}/search-students/?query=${encodeURIComponent(query)}`;

        fetch(searchUrl)
            .then(response => response.json())
            .then(data => {
                const resultsContainer = document.getElementById('student-search-results');
                resultsContainer.innerHTML = '';
                if (data.students && data.students.length > 0) {
                    const studentList = document.createElement('ul');
                    studentList.className = 'list-group';
                    data.students.forEach(student => {
                        const listItem = document.createElement('li');
                        listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                        
                        let buttonClass = 'btn-primary';
                        let buttonText = 'Mark Present';
                        let disabled = false;

                        if (student.attendance_status === 'approved') {
                            buttonClass = 'btn-success';
                            buttonText = 'Approved';
                            disabled = true;
                        } else if (student.attendance_status === 'pending') {
                            buttonClass = 'btn-warning';
                            buttonText = 'Pending';
                            disabled = true;
                        } else if (student.attendance_status === 'rejected') {
                            buttonClass = 'btn-danger';
                            buttonText = 'Rejected';
                            disabled = true;
                        }

                        listItem.innerHTML = `
                            <span>${student.name} (${student.roll_no || 'N/A'})</span>
                            <button class="btn btn-sm ${buttonClass} mark-present-btn" 
                                    data-student-id="${student.id}" ${disabled ? 'disabled' : ''}>
                                ${buttonText}
                            </button>
                        `;
                        studentList.appendChild(listItem);
                    });
                    resultsContainer.appendChild(studentList);
                } else {
                    resultsContainer.innerHTML = '<p class="text-center text-muted">No students found.</p>';
                }
            });
    });

    document.getElementById('student-search-results').addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('mark-present-btn')) {
            const button = e.target;
            const studentId = button.dataset.studentId;
            const markUrl = `/teacher/lecture/${lectureId}/mark-manual-attendance/`;

            const formData = new FormData();
            formData.append('student_id', studentId);

            fetch(markUrl, {
                method: 'POST',
                body: formData,
                headers: { 'X-CSRFToken': csrfToken }
            })
            .then(response => response.json())
            .then(data => {
                showAlert('manual-attendance-alert', data.message, data.success ? 'success' : 'danger');
                if (data.success) {
                    button.textContent = 'Marked';
                    button.classList.remove('btn-primary');
                    button.classList.add('btn-secondary');
                    button.disabled = true;
                }
            });
        }
    });

    function showAlert(alertId, message, type) {
        const alertDiv = document.getElementById(alertId);
        alertDiv.textContent = message;
        alertDiv.className = `alert alert-${type}`;
        alertDiv.style.display = 'block';
        setTimeout(() => { alertDiv.style.display = 'none'; }, 4000);
    }
</script>
{% endblock %}
</div>
{% endblock %}
